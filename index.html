<!DOCTYPE html><html class="default" lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>Orphic Cypress</title><meta name="description" content="Documentation for Orphic Cypress"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="assets/style.css"/><link rel="stylesheet" href="assets/highlight.css"/><script async src="assets/search.js" id="search-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os"</script><header class="tsd-page-toolbar">
<div class="tsd-toolbar-contents container">
<div class="table-cell" id="tsd-search" data-base=".">
<div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M15.7824 13.833L12.6666 10.7177C12.5259 10.5771 12.3353 10.499 12.1353 10.499H11.6259C12.4884 9.39596 13.001 8.00859 13.001 6.49937C13.001 2.90909 10.0914 0 6.50048 0C2.90959 0 0 2.90909 0 6.49937C0 10.0896 2.90959 12.9987 6.50048 12.9987C8.00996 12.9987 9.39756 12.4863 10.5008 11.6239V12.1332C10.5008 12.3332 10.5789 12.5238 10.7195 12.6644L13.8354 15.7797C14.1292 16.0734 14.6042 16.0734 14.8948 15.7797L15.7793 14.8954C16.0731 14.6017 16.0731 14.1267 15.7824 13.833ZM6.50048 10.499C4.29094 10.499 2.50018 8.71165 2.50018 6.49937C2.50018 4.29021 4.28781 2.49976 6.50048 2.49976C8.71001 2.49976 10.5008 4.28708 10.5008 6.49937C10.5008 8.70852 8.71314 10.499 6.50048 10.499Z" fill="var(--color-text)"></path></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div>
<div class="field">
<div id="tsd-toolbar-links"><a href="https://quotapath.github.io/orphic-cypress/storybook/">Storybook</a><a href="https://github.com/quotapath/orphic-cypress">Github</a></div></div>
<ul class="results">
<li class="state loading">Preparing search index...</li>
<li class="state failure">The search index is not available</li></ul><a href="index.html" class="title">Orphic Cypress</a></div>
<div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><rect x="1" y="3" width="14" height="2" fill="var(--color-text)"></rect><rect x="1" y="7" width="14" height="2" fill="var(--color-text)"></rect><rect x="1" y="11" width="14" height="2" fill="var(--color-text)"></rect></svg></a></div></div></header>
<div class="container container-main">
<div class="col-8 col-content">
<div class="tsd-page-title">
<h2>Orphic Cypress</h2></div>
<div class="tsd-panel tsd-typography"><div align="center">
  <img
    src="https://user-images.githubusercontent.com/9889378/203303857-c5e4682d-afda-4956-bd3b-d54630a7041c.jpeg"
    alt="Van Gogh's Painting of 'Road with Cypress and Star'"
    width="400px"
  />
</div>


<a href="#orphic-cypress" id="orphic-cypress" style="color: inherit; text-decoration: none;">
  <h1>Orphic Cypress</h1>
</a>
<p><a href="https://quotapath.github.io/orphic-cypress/storybook/"><img src="https://raw.githubusercontent.com/storybookjs/brand/main/badge/badge-storybook.svg" alt="Storybook"></a> <a href="https://quotapath.github.io/orphic-cypress/"><img height="20" src="https://user-images.githubusercontent.com/9889378/203390045-ba98e185-2701-42d7-9c26-a9dae3446ece.png" /></a> <a href="https://github.com/quotapath/orphic-cypress/actions/workflows/ci.yml"><img src="https://github.com/quotapath/orphic-cypress/actions/workflows/ci.yml/badge.svg" alt="CI"></a> <a href="https://quotapath.github.io/orphic-cypress/lcov-report"><img src="https://quotapath.github.io/orphic-cypress/test-coverage.svg" alt="test coverage"></a> <a href="https://www.npmjs.com/package/orphic-cypress"><img src="https://badge.fury.io/js/orphic-cypress.svg" alt="npm version"></a></p>
<p>A set of utilities, typescript transformers, and general examples on how to cover storybook stories with cypress component tests.
In short, this is a little overengineering, a little black magic, and a lot of documentation on making these kinds of tests as easy and concise as possible.</p>

<a href="#features" id="features" style="color: inherit; text-decoration: none;">
  <h2>Features</h2>
</a>
<ul>
<li><a href="https://quotapath.github.io/orphic-cypress/storybook/">A comprehensive set of examples</a> for using cypress to test storybook with or without tools given here, including some surprising finds <a href="https://quotapath.github.io/orphic-cypress/storybook/?path=/docs/mdx-file-with-external-tests">like how to use composeStories with mdx files</a></li>
<li>An automatic cypress component test executor for plain old storybook stories, written in typescript or mdx</li>
<li><a href="#additional-syntaxes">A series of file syntaxes</a> to support <code>.play</code> like functionality in story files</li>
<li><a href="#stubbing-actions">Automatic action stubs and spies</a> with first level cypress support</li>
<li><a href="#isolated-component-files-transformer">A typescript transform</a> that turns your <code>stories.tsx</code> files into cypress test files with just a bit of black magic</li>
<li>Tools for turning <a href="#intercepting-api-requests">storybook addon mock api calls into cypress intercepts</a></li>
<li>General storybook doc utils for building <a href="https://quotapath.github.io/orphic-cypress/functions/storybook_story_code.transformSource.html">snippets from storysource</a> or to <a href="https://quotapath.github.io/orphic-cypress/functions/storybook_segment_mdx.segmentMdx.html">segment an mdx file</a> to use in multiple doc locations.</li>
<li>When taken to the extreme, this is a mechanism for <a href="#literate-testing">literate testing!</a></li>
</ul>
<p>See extended module documentation in <a href="https://quotapath.github.io/orphic-cypress/">github pages</a> and numerous examples at a <a href="https://quotapath.github.io/orphic-cypress/storybook/">hosted storybook</a></p>
<br/>


<a href="#what-this-is" id="what-this-is" style="color: inherit; text-decoration: none;">
  <h1>What this is</h1>
</a>
<p>We love storybook and component driven development, but we also love cypress!</p>
<p>We were initially excited about <a href="https://storybook.js.org/docs/react/writing-tests/interaction-testing">storybook&#39;s interaction testing</a>. We even wrote some tests and committed to it as the right direction to translating over our early enzyme tests.</p>
<p>Ultimately though, we found that bringing in net-new technologies like jest and testing-library was too much cognitive overhead and code dissonance alongside our existing end-to-end tests in cypress and unit tests in the mocha/chai/sinon stack.</p>
<p>So, we set out to come up with a standard for executing storybook tests in cypress with just the right balance of spooky magic. We wanted minimal boilerplate to encourage writing tests early and often, and to cover stories which don&#39;t have explicit tests to prevent stories going stale and breaking. Although it&#39;s with a heavy heart that we leave behind some of the benefits of storybook&#39;s solution, we&#39;re thrilled to have test coverage that fits with our existing paradigms. And cypress component testing is really slick.</p>
<br/>


<a href="#using-this-package" id="using-this-package" style="color: inherit; text-decoration: none;">
  <h1>Using this package</h1>
</a>
<p>As is, you could set up cypress component testing following <a href="https://docs.cypress.io/guides/component-testing/quickstart-react#Configuring-Component-Testing">their guide</a> and write tests like this without any need for the code in this package.</p>
<pre><code class="language-tsx"><span class="hl-0">import</span><span class="hl-1"> { </span><span class="hl-2">composeStories</span><span class="hl-1"> } </span><span class="hl-0">from</span><span class="hl-1"> </span><span class="hl-3">&quot;@storybook/testing-react&quot;</span><span class="hl-1">;</span><br/><span class="hl-0">import</span><span class="hl-1"> </span><span class="hl-2">React</span><span class="hl-1"> </span><span class="hl-0">from</span><span class="hl-1"> </span><span class="hl-3">&quot;react&quot;</span><span class="hl-1">;</span><br/><br/><span class="hl-0">import</span><span class="hl-1"> </span><span class="hl-4">*</span><span class="hl-1"> </span><span class="hl-0">as</span><span class="hl-1"> </span><span class="hl-2">stories</span><span class="hl-1"> </span><span class="hl-0">from</span><span class="hl-1"> </span><span class="hl-3">&quot;./index.stories&quot;</span><span class="hl-1">;</span><br/><br/><span class="hl-4">const</span><span class="hl-1"> { </span><span class="hl-5">CompWithLabel</span><span class="hl-1"> } = </span><span class="hl-6">composeStories</span><span class="hl-1">(</span><span class="hl-2">stories</span><span class="hl-1">);</span><br/><br/><span class="hl-6">describe</span><span class="hl-1">(</span><span class="hl-3">&quot;SomeComponent&quot;</span><span class="hl-1">, () </span><span class="hl-4">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-6">it</span><span class="hl-1">(</span><span class="hl-3">&quot;should render ok&quot;</span><span class="hl-1">, () </span><span class="hl-4">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-2">cy</span><span class="hl-1">.</span><span class="hl-6">mount</span><span class="hl-1">(</span><span class="hl-7">&lt;</span><span class="hl-8">CompWithLabel</span><span class="hl-1"> </span><span class="hl-7">/&gt;</span><span class="hl-1">);</span><br/><span class="hl-1">  });</span><br/><br/><span class="hl-1">  </span><span class="hl-6">it</span><span class="hl-1">(</span><span class="hl-3">&quot;should show the provided label&quot;</span><span class="hl-1">, () </span><span class="hl-4">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-2">cy</span><span class="hl-1">.</span><span class="hl-6">mount</span><span class="hl-1">(</span><span class="hl-7">&lt;</span><span class="hl-8">CompWithLabel</span><span class="hl-1"> </span><span class="hl-7">/&gt;</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-2">cy</span><span class="hl-1">.</span><span class="hl-6">get</span><span class="hl-1">(</span><span class="hl-3">&quot;.typography&quot;</span><span class="hl-1">).</span><span class="hl-6">should</span><span class="hl-1">(</span><span class="hl-3">&quot;be.visible&quot;</span><span class="hl-1">).</span><span class="hl-6">and</span><span class="hl-1">(</span><span class="hl-3">&quot;contain&quot;</span><span class="hl-1">, </span><span class="hl-3">&quot;test&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">  });</span><br/><span class="hl-1">});</span>
</code></pre>
<p>But, that could conceivably be seen as a lot of boilerplate, especially when compared to the <code>play</code> syntax of storybook&#39;s interactive tests. You&#39;d have to drop something like this into every directory containing a storybook story and perform the <code>should render ok</code> test to make sure your stories aren&#39;t breaking. And we haven&#39;t even gotten into things like stubbing actions or mocking API calls, which would be duplicative of storybook setup.</p>
<p>Instead we could write some simple utilities so that we can keep the files in the <code>*.stories.tsx</code>:</p>
<pre><code class="language-tsx"><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-6">CompWithLabel</span><span class="hl-1"> = () </span><span class="hl-4">=&gt;</span><span class="hl-1"> </span><span class="hl-7">&lt;</span><span class="hl-8">Something</span><span class="hl-1"> </span><span class="hl-9">label</span><span class="hl-1">=</span><span class="hl-3">&quot;test&quot;</span><span class="hl-1"> </span><span class="hl-7">/&gt;</span><span class="hl-1">; </span><span class="hl-10">// this story was already here</span><br/><span class="hl-2">CompWithLabel</span><span class="hl-1">.</span><span class="hl-6">cy</span><span class="hl-1"> = () </span><span class="hl-4">=&gt;</span><br/><span class="hl-1">  </span><span class="hl-2">cy</span><span class="hl-1">.</span><span class="hl-6">get</span><span class="hl-1">(</span><span class="hl-3">&quot;.typography&quot;</span><span class="hl-1">).</span><span class="hl-6">should</span><span class="hl-1">(</span><span class="hl-3">&quot;be.visible&quot;</span><span class="hl-1">).</span><span class="hl-6">and</span><span class="hl-1">(</span><span class="hl-3">&quot;contain&quot;</span><span class="hl-1">, </span><span class="hl-3">&quot;test&quot;</span><span class="hl-1">);</span>
</code></pre>
<br/>


<a href="#additional-syntaxes" id="additional-syntaxes" style="color: inherit; text-decoration: none;">
  <h1>Additional Syntaxes</h1>
</a>
<p>There are 3 available syntaxes for in-file use. See <a href="https://quotapath.github.io/orphic-cypress/storybook/?path=/docs/fileformats-storybookfiles">storybook</a> for comprehensive examples.</p>

<a href="#function-syntax" id="function-syntax" style="color: inherit; text-decoration: none;">
  <h2><code>function</code> syntax</h2>
</a>
<p>already shown above is the most succinct</p>
<pre><code class="language-ts"><span class="hl-2">CompWithLabel</span><span class="hl-1">.</span><span class="hl-6">cy</span><span class="hl-1"> = () </span><span class="hl-4">=&gt;</span><br/><span class="hl-1">  </span><span class="hl-2">cy</span><span class="hl-1">.</span><span class="hl-6">get</span><span class="hl-1">(</span><span class="hl-3">&quot;.typography&quot;</span><span class="hl-1">).</span><span class="hl-6">should</span><span class="hl-1">(</span><span class="hl-3">&quot;be.visible&quot;</span><span class="hl-1">).</span><span class="hl-6">and</span><span class="hl-1">(</span><span class="hl-3">&quot;contain&quot;</span><span class="hl-1">, </span><span class="hl-3">&quot;test&quot;</span><span class="hl-1">);</span>
</code></pre>

<a href="#object-syntax" id="object-syntax" style="color: inherit; text-decoration: none;">
  <h2><code>object</code> syntax</h2>
</a>
<p>allows you to tag the test with a description of the expectation and to write multiple tests for the same component</p>
<pre><code class="language-ts"><span class="hl-2">CompWithLabel</span><span class="hl-1">.</span><span class="hl-2">cy</span><span class="hl-1"> = {</span><br/><span class="hl-1">  </span><span class="hl-3">&quot;should contain the &#39;test&#39; label&quot;</span><span class="hl-2">:</span><span class="hl-1"> () </span><span class="hl-4">=&gt;</span><br/><span class="hl-1">    </span><span class="hl-2">cy</span><span class="hl-1">.</span><span class="hl-6">get</span><span class="hl-1">(</span><span class="hl-3">&quot;.typography&quot;</span><span class="hl-1">).</span><span class="hl-6">should</span><span class="hl-1">(</span><span class="hl-3">&quot;be.visible&quot;</span><span class="hl-1">).</span><span class="hl-6">and</span><span class="hl-1">(</span><span class="hl-3">&quot;contain&quot;</span><span class="hl-1">, </span><span class="hl-3">&quot;test&quot;</span><span class="hl-1">),</span><br/><br/><span class="hl-1">  </span><span class="hl-3">&quot;should show an expanded label when clicked&quot;</span><span class="hl-2">:</span><span class="hl-1"> () </span><span class="hl-4">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-2">cy</span><span class="hl-1">.</span><span class="hl-6">get</span><span class="hl-1">(</span><span class="hl-3">&quot;.typography&quot;</span><span class="hl-1">).</span><span class="hl-6">click</span><span class="hl-1">();</span><br/><span class="hl-1">    </span><span class="hl-2">cy</span><span class="hl-1">.</span><span class="hl-6">get</span><span class="hl-1">(</span><span class="hl-3">&quot;.expanded-label&quot;</span><span class="hl-1">)</span><br/><span class="hl-1">      .</span><span class="hl-6">should</span><span class="hl-1">(</span><span class="hl-3">&quot;be.visible&quot;</span><span class="hl-1">)</span><br/><span class="hl-1">      .</span><span class="hl-6">and</span><span class="hl-1">(</span><span class="hl-3">&quot;contain&quot;</span><span class="hl-1">, </span><span class="hl-3">&quot;more details here&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">};</span>
</code></pre>
<p>Each of these is executed in it&#39;s own isolated <code>it</code> function.</p>

<a href="#cytest-syntax" id="cytest-syntax" style="color: inherit; text-decoration: none;">
  <h2><code>cyTest</code> syntax</h2>
</a>
<p>allows the most control but backs off of some of the automatic setup that takes place</p>
<pre><code class="language-tsx"><span class="hl-2">CompWithLabel</span><span class="hl-1">.</span><span class="hl-6">cyTest</span><span class="hl-1"> = (</span><span class="hl-2">Story</span><span class="hl-1">) </span><span class="hl-4">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-6">it</span><span class="hl-1">(</span><span class="hl-3">&quot;should contain the &#39;test&#39; label&quot;</span><span class="hl-1">, () </span><span class="hl-4">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-2">cy</span><span class="hl-1">.</span><span class="hl-6">mount</span><span class="hl-1">(</span><span class="hl-7">&lt;</span><span class="hl-8">Story</span><span class="hl-1"> </span><span class="hl-7">/&gt;</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-2">cy</span><span class="hl-1">.</span><span class="hl-6">get</span><span class="hl-1">(</span><span class="hl-3">&quot;.typography&quot;</span><span class="hl-1">).</span><span class="hl-6">should</span><span class="hl-1">(</span><span class="hl-3">&quot;be.visible&quot;</span><span class="hl-1">).</span><span class="hl-6">and</span><span class="hl-1">(</span><span class="hl-3">&quot;contain&quot;</span><span class="hl-1">, </span><span class="hl-3">&quot;test&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">  });</span><br/><br/><span class="hl-1">  </span><span class="hl-6">it</span><span class="hl-1">(</span><span class="hl-3">&quot;should show an expanded label when clicked&quot;</span><span class="hl-1">, () </span><span class="hl-4">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-2">cy</span><span class="hl-1">.</span><span class="hl-6">mount</span><span class="hl-1">(</span><span class="hl-7">&lt;</span><span class="hl-8">Story</span><span class="hl-1"> </span><span class="hl-9">additionalArgs</span><span class="hl-1">=</span><span class="hl-3">&quot;more details&quot;</span><span class="hl-1"> </span><span class="hl-7">/&gt;</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-2">cy</span><span class="hl-1">.</span><span class="hl-6">get</span><span class="hl-1">(</span><span class="hl-3">&quot;.typography&quot;</span><span class="hl-1">).</span><span class="hl-6">click</span><span class="hl-1">();</span><br/><span class="hl-1">    </span><span class="hl-2">cy</span><span class="hl-1">.</span><span class="hl-6">get</span><span class="hl-1">(</span><span class="hl-3">&quot;.expanded-label&quot;</span><span class="hl-1">)</span><br/><span class="hl-1">      .</span><span class="hl-6">should</span><span class="hl-1">(</span><span class="hl-3">&quot;be.visible&quot;</span><span class="hl-1">)</span><br/><span class="hl-1">      .</span><span class="hl-6">and</span><span class="hl-1">(</span><span class="hl-3">&quot;contain&quot;</span><span class="hl-1">, </span><span class="hl-3">&quot;more details here&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">  });</span><br/><span class="hl-1">};</span>
</code></pre>
<p>This executes within it&#39;s own <code>describe</code> block and is useful for providing component props or setup not included in stories, or for writing <code>before</code>, <code>beforeEach</code>, etc hooks.</p>
<p>All of these properties could also be added to the story&#39;s <code>parameters</code>. That might be more canonical but is often messier and less-well-typed. In mdx files, they <em>must</em>
be parameters:</p>
<pre><code class="language-tsx"><span class="hl-7">&lt;</span><span class="hl-8">Story</span><br/><span class="hl-1">  </span><span class="hl-9">name</span><span class="hl-1">=</span><span class="hl-3">&quot;StoryFunctionWithCyFunction&quot;</span><br/><span class="hl-1">  </span><span class="hl-9">parameters</span><span class="hl-1">=</span><span class="hl-4">{</span><span class="hl-11">{</span><br/><span class="hl-11">    </span><span class="hl-6">cy</span><span class="hl-2">:</span><span class="hl-11"> () </span><span class="hl-4">=&gt;</span><span class="hl-11"> </span><span class="hl-2">cy</span><span class="hl-11">.</span><span class="hl-6">dataCy</span><span class="hl-11">(</span><span class="hl-3">&quot;button&quot;</span><span class="hl-11">).</span><span class="hl-6">should</span><span class="hl-11">(</span><span class="hl-3">&quot;contain&quot;</span><span class="hl-11">, </span><span class="hl-3">&quot;Story function&quot;</span><span class="hl-11">),</span><br/><span class="hl-11">  }</span><span class="hl-4">}</span><br/><span class="hl-7">&gt;</span><br/><span class="hl-1">  </span><span class="hl-4">{</span><span class="hl-11">(</span><span class="hl-2">args</span><span class="hl-11">) </span><span class="hl-4">=&gt;</span><span class="hl-11"> </span><span class="hl-7">&lt;</span><span class="hl-8">Button</span><span class="hl-11"> </span><span class="hl-4">{</span><span class="hl-1">...</span><span class="hl-2">args</span><span class="hl-4">}</span><span class="hl-11"> </span><span class="hl-9">label</span><span class="hl-1">=</span><span class="hl-3">&quot;Story function&quot;</span><span class="hl-11"> </span><span class="hl-7">/&gt;</span><span class="hl-4">}</span><br/><span class="hl-7">&lt;/</span><span class="hl-8">Story</span><span class="hl-7">&gt;</span>
</code></pre>
<p>See more mdx examples in storybook <a href="https://quotapath.github.io/orphic-cypress/storybook/?path=/docs/mdx-mdxautomatictestfileformats-storybookfiles--story-function-with-cy-function">here and in surrounding stories</a></p>

<a href="#opting-out" id="opting-out" style="color: inherit; text-decoration: none;">
  <h2>Opting out</h2>
</a>
<p>You can opt out of allowing any or all of these syntaxes via cypress configuration. See <a href="https://quotapath.github.io/orphic-cypress/types/config.CyTestConfig.html">config module documentation</a> for more details.</p>
<br/>


<a href="#stubbing-actions" id="stubbing-actions" style="color: inherit; text-decoration: none;">
  <h1>Stubbing Actions</h1>
</a>
<p>By default, <code>composeStories</code> will not stub your actions. This package introduces <code>stubStoryActions</code> to do this automatically when running in the cypress test mode. See <a href="md-docs/modules/actions.md#stubstoryactions">its documentation</a> for manual use.</p>
<p>See <a href="https://quotapath.github.io/orphic-cypress/storybook/?path=/docs/stubactions">storybook</a> for example uses with various file types and configurations, and <a href="https://quotapath.github.io/orphic-cypress/functions/actions.stubStoryActions.html">module docs</a> for more details</p>
<p>Cypress component test stubs are really slick and the test runner provides a great, interactive interface for debugging</p>
<p><a href="https://user-images.githubusercontent.com/9889378/203308863-105eac48-a70a-4c21-a439-dead63ef0aed.mp4">https://user-images.githubusercontent.com/9889378/203308863-105eac48-a70a-4c21-a439-dead63ef0aed.mp4</a></p>
<br/>


<a href="#isolated-component-files-transformer" id="isolated-component-files-transformer" style="color: inherit; text-decoration: none;">
  <h1>Isolated Component Files Transformer</h1>
</a>
<p>There are two ways to run these tests: via importing all storybook files by glob and iterating through them in one file, or by using a little bit of black magic in the form of a typescript transformer to enable the storybook typescript and mdx files themselves to act as the cypress tests. This is perhaps best explained with a couple of screenshots.</p>
<p><img src="https://user-images.githubusercontent.com/9889378/206868377-27d1b7d9-dd85-477a-bd31-fb6e4a04b6f4.png" alt="required tests">
<img src="https://user-images.githubusercontent.com/9889378/206868376-e9b60b72-4883-401d-a34e-a46dba76dd50.png" alt="isolated tests"></p>
<p>The first is the approach via a single file, and the second is via the transformer. The require approach is decently faster despite the actual test execution time being equivalent. That&#39;s helped a bit by <a href="https://docs.cypress.io/guides/references/experiments#Component-Testing">experimentSingleTabRunMode</a>, which seems pretty stable, but the transformer version is about half as slow. What the latter gives you though is isolation and debugability. You can <code>-s</code> to specify a spec pattern and run just a single test, you can add <code>.only</code> or the orphic-cypress equivalent <code>.cyOnly</code> and only affect the one file&#39;s worth of tests. And most importantly you can pull up a headed run and execute just a single file&#39;s tests.</p>
<p><img src="https://user-images.githubusercontent.com/9889378/206868853-ae2c148d-6088-4c3c-9857-3e610869a3af.png" alt="isolated tests spec screen">
<img src="https://user-images.githubusercontent.com/9889378/206868833-0bfb4914-56d3-41aa-beee-bd8dc83dcd41.png" alt="isolated tests single run"></p>
<p>The files are the tests, which is exactly the mental model cypress uses. The way that works is by taking a file like this</p>
<pre><code class="language-tsx"><span class="hl-0">import</span><span class="hl-1"> </span><span class="hl-0">type</span><span class="hl-1"> { </span><span class="hl-2">ComponentStory</span><span class="hl-1">, </span><span class="hl-2">ComponentStoryObj</span><span class="hl-1"> } </span><span class="hl-0">from</span><span class="hl-1"> </span><span class="hl-3">&quot;@storybook/react&quot;</span><span class="hl-1">;</span><br/><span class="hl-0">import</span><span class="hl-1"> { </span><span class="hl-2">Comp</span><span class="hl-1"> } </span><span class="hl-0">from</span><span class="hl-1"> </span><span class="hl-3">&quot;components/Comp&quot;</span><span class="hl-1">;</span><br/><span class="hl-0">import</span><span class="hl-1"> </span><span class="hl-4">*</span><span class="hl-1"> </span><span class="hl-0">as</span><span class="hl-1"> </span><span class="hl-2">React</span><span class="hl-1"> </span><span class="hl-0">from</span><span class="hl-1"> </span><span class="hl-3">&quot;react&quot;</span><span class="hl-1">;</span><br/><span class="hl-0">export</span><span class="hl-1"> </span><span class="hl-0">default</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-2">component:</span><span class="hl-1"> </span><span class="hl-2">Comp</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-2">title:</span><span class="hl-1"> </span><span class="hl-3">&quot;Component&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">};</span><br/><span class="hl-0">export</span><span class="hl-1"> </span><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-6">StoryFn</span><span class="hl-1">: </span><span class="hl-8">ComponentStory</span><span class="hl-1">&lt;</span><span class="hl-4">typeof</span><span class="hl-1"> </span><span class="hl-2">Comp</span><span class="hl-1">&gt; = (</span><span class="hl-2">args</span><span class="hl-1">) </span><span class="hl-4">=&gt;</span><span class="hl-1"> (</span><br/><span class="hl-1">  </span><span class="hl-7">&lt;</span><span class="hl-8">Comp</span><span class="hl-1"> </span><span class="hl-4">{</span><span class="hl-1">...</span><span class="hl-2">args</span><span class="hl-4">}</span><span class="hl-1"> </span><span class="hl-7">/&gt;</span><br/><span class="hl-1">);</span><br/><span class="hl-0">export</span><span class="hl-1"> </span><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-5">StoryObj</span><span class="hl-1">: </span><span class="hl-8">ComponentStoryObj</span><span class="hl-1">&lt;</span><span class="hl-4">typeof</span><span class="hl-1"> </span><span class="hl-2">Comp</span><span class="hl-1">&gt; = {</span><br/><span class="hl-1">  </span><span class="hl-2">args:</span><span class="hl-1"> { </span><span class="hl-2">label:</span><span class="hl-1"> </span><span class="hl-3">&quot;test&quot;</span><span class="hl-1"> },</span><br/><span class="hl-1">};</span>
</code></pre>
<p>and during the typescript compilation process, add a line at the top and bottom:</p>
<pre><code class="language-ts"><span class="hl-0">import</span><span class="hl-1"> { </span><span class="hl-2">executeCyTests</span><span class="hl-1"> } </span><span class="hl-0">from</span><span class="hl-1"> </span><span class="hl-3">&quot;orphic-cypress&quot;</span><span class="hl-1">;</span><br/><span class="hl-10">// whole rest of file...</span><br/><span class="hl-6">executeCyTests</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-2">default:</span><span class="hl-1"> { </span><span class="hl-2">component:</span><span class="hl-1"> </span><span class="hl-2">Comp</span><span class="hl-1">, </span><span class="hl-2">title:</span><span class="hl-1"> </span><span class="hl-3">&quot;Component&quot;</span><span class="hl-1"> },</span><br/><span class="hl-1">  </span><span class="hl-2">StoryFn</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-2">StoryObj</span><span class="hl-1">,</span><br/><span class="hl-1">});</span>
</code></pre>
<p>You can read about how to add it to webpack <a href="https://quotapath.github.io/orphic-cypress/functions/transformers.transformIsolatedComponentFiles-1.html">here</a>, it should also work with other mechanisms of involving transformers in the typescript process.</p>
<p>The require version uses that same <a href="https://quotapath.github.io/orphic-cypress/functions/execute.executeCyTests.html">executeCyTests</a>, though it has to loop through files and execute in one describe block, just a bit truncated</p>
<pre><code class="language-ts"><span class="hl-6">describe</span><span class="hl-1">(</span><span class="hl-2">description</span><span class="hl-1">, () </span><span class="hl-4">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-2">Cypress</span><span class="hl-1">.</span><span class="hl-6">env</span><span class="hl-1">(</span><span class="hl-3">&quot;storybookFiles&quot;</span><span class="hl-1">).</span><span class="hl-6">forEach</span><span class="hl-1">((</span><span class="hl-2">file</span><span class="hl-1">: </span><span class="hl-8">string</span><span class="hl-1">) </span><span class="hl-4">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-5">stories</span><span class="hl-1"> = </span><span class="hl-6">requireFileCallback</span><span class="hl-1">(</span><span class="hl-2">file</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-6">executeCyTests</span><span class="hl-1">(</span><span class="hl-2">stories</span><span class="hl-1">, </span><span class="hl-2">stories</span><span class="hl-1">.</span><span class="hl-2">default</span><span class="hl-1">.</span><span class="hl-2">title</span><span class="hl-1"> || </span><span class="hl-2">file</span><span class="hl-1">);</span><br/><span class="hl-1">  });</span><br/><span class="hl-1">});</span>
</code></pre>

<a href="#finally-how-to-actually-run-the-thing" id="finally-how-to-actually-run-the-thing" style="color: inherit; text-decoration: none;">
  <h2>Finally, how to actually run the thing</h2>
</a>
<p>This repo sets up and runs both require and isolated tests, and contains commands for headed versions of both. It&#39;s hopefully a good reference besides the docs. Look to <a href="https://github.com/quotapath/orphic-cypress/blob/main/cypress.config.ts">the cypress config file</a>, the <a href="https://github.com/quotapath/orphic-cypress/blob/main/package.json#L7">package.json scripts</a> and the <a href="https://github.com/quotapath/orphic-cypress/blob/main/stories/mount.cy.ts">mount test</a>.</p>

<a href="#isolated-files" id="isolated-files" style="color: inherit; text-decoration: none;">
  <h3>Isolated Files</h3>
</a>
<p>To run isolated tests, you won&#39;t need much config: just get the transformer in place and then run with <code>CYPRESS_USE_ISOLATED_CT_FILES=true</code> environment variable set. Details on that transformer webpack config are again <a href="https://quotapath.github.io/orphic-cypress/functions/transformers.transformIsolatedComponentFiles-1.html">here</a>, but I&#39;ll copy in a snippet from orphic-cypress&#39; <a href="https://github.com/quotapath/orphic-cypress/blob/main/webpack.config.ts">webpack config</a> for overkill</p>
<pre><code class="language-ts"><span class="hl-0">import</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-2">transformIsolatedComponentFiles</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-2">useIsolatedComponentFiles</span><span class="hl-1">,</span><br/><span class="hl-1">} </span><span class="hl-0">from</span><span class="hl-1"> </span><span class="hl-3">&quot;orphic-cypress&quot;</span><span class="hl-1">;</span><br/><br/><span class="hl-8">module</span><span class="hl-1">.</span><span class="hl-8">exports</span><span class="hl-1"> = {</span><br/><span class="hl-1">  </span><span class="hl-10">// ...</span><br/><span class="hl-1">  </span><span class="hl-2">module:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-10">// hide warnings for &#39;Critical dependency: require function is used in a way</span><br/><span class="hl-1">    </span><span class="hl-10">// in which dependencies cannot be statically extracted&#39;, at least in packages</span><br/><span class="hl-1">    </span><span class="hl-2">exprContextCritical:</span><span class="hl-1"> </span><span class="hl-4">false</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-2">rules:</span><span class="hl-1"> [</span><br/><span class="hl-1">      {</span><br/><span class="hl-1">        </span><span class="hl-2">test:</span><span class="hl-12"> /</span><span class="hl-13">\.</span><span class="hl-14">[</span><span class="hl-12">jt</span><span class="hl-14">]</span><span class="hl-12">sx</span><span class="hl-15">?</span><span class="hl-16">$</span><span class="hl-12">/</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-2">exclude:</span><span class="hl-1"> [</span><span class="hl-12">/node_modules/</span><span class="hl-1">],</span><br/><span class="hl-1">        </span><span class="hl-2">use:</span><span class="hl-1"> [</span><br/><span class="hl-1">          {</span><br/><span class="hl-1">            </span><span class="hl-2">loader:</span><span class="hl-1"> </span><span class="hl-3">&quot;ts-loader&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">            </span><span class="hl-2">options:</span><span class="hl-1"> {</span><br/><span class="hl-1">              </span><span class="hl-2">happyPackMode:</span><span class="hl-1"> </span><span class="hl-4">true</span><span class="hl-1">,</span><br/><span class="hl-1">              </span><span class="hl-2">transpileOnly:</span><span class="hl-1"> </span><span class="hl-4">true</span><span class="hl-1">,</span><br/><span class="hl-1">              ...(</span><span class="hl-2">useIsolatedComponentFiles</span><span class="hl-1"> &amp;&amp; {</span><br/><span class="hl-1">                </span><span class="hl-6">getCustomTransformers</span><span class="hl-2">:</span><span class="hl-1"> () </span><span class="hl-4">=&gt;</span><span class="hl-1"> ({</span><br/><span class="hl-1">                  </span><span class="hl-2">before:</span><span class="hl-1"> [</span><span class="hl-6">transformIsolatedComponentFiles</span><span class="hl-1">()],</span><br/><span class="hl-1">                }),</span><br/><span class="hl-1">              }),</span><br/><span class="hl-1">            },</span><br/><span class="hl-1">          },</span><br/><span class="hl-1">        ],</span><br/><span class="hl-1">      },</span><br/><span class="hl-1">    ],</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">};</span>
</code></pre>
<p><code>useIsolatedComponentFiles</code> is just the boolean from <code>CYPRESS_USE_ISOLATED_CT_FILES</code> env var and it can be used elsewhere for convenience.</p>

<a href="#require-files" id="require-files" style="color: inherit; text-decoration: none;">
  <h3>Require Files</h3>
</a>
<p>The <code>require</code> version takes more configuration. You&#39;ll need to set storybook files in the cypress config file&#39;s component test section via <a href="https://quotapath.github.io/orphic-cypress/functions/mount.setStorybookFiles.html">setStoryBookFiles</a></p>
<pre><code class="language-ts"><span class="hl-0">export</span><span class="hl-1"> </span><span class="hl-0">default</span><span class="hl-1"> </span><span class="hl-6">defineConfig</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-2">component:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-6">setupNodeEvents</span><span class="hl-2">:</span><span class="hl-1"> (</span><span class="hl-2">on</span><span class="hl-1">, </span><span class="hl-2">config</span><span class="hl-1">) </span><span class="hl-4">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-6">setStorybookFiles</span><span class="hl-1">(</span><span class="hl-2">on</span><span class="hl-1">, </span><span class="hl-2">config</span><span class="hl-1">);</span><br/><span class="hl-1">      </span><span class="hl-0">return</span><span class="hl-1"> </span><span class="hl-2">config</span><span class="hl-1">;</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">});</span>
</code></pre>
<p>Then call <a href="">mountTest</a> in a <code>Something.cy.tsx</code> named file, passing it a <a href="https://quotapath.github.io/orphic-cypress/types/mount.RequireFileCallback.html">requireFileCallback</a> which necessarily has to have a bit of manual input to get webpack to import correctly. This is copied from the <code>requireFileCallback</code> link above, but for our real world case, that looked like</p>
<pre><code class="language-ts"><span class="hl-10">// in mount.cy.tsx</span><br/><span class="hl-0">import</span><span class="hl-1"> { </span><span class="hl-2">mountTest</span><span class="hl-1"> } </span><span class="hl-0">from</span><span class="hl-1"> </span><span class="hl-3">&quot;orphic-cypress&quot;</span><span class="hl-1">;</span><br/><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-6">requireFileCallback</span><span class="hl-1">: </span><span class="hl-8">RequireFileCallback</span><span class="hl-1"> = (</span><span class="hl-2">fullFilePath</span><span class="hl-1">: </span><span class="hl-8">string</span><span class="hl-1">) </span><span class="hl-4">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-5">replaced</span><span class="hl-1"> = </span><span class="hl-2">fullFilePath</span><br/><span class="hl-1">    .</span><span class="hl-6">replace</span><span class="hl-1">(</span><span class="hl-3">&quot;src/app/&quot;</span><span class="hl-1">, </span><span class="hl-3">&quot;&quot;</span><span class="hl-1">)</span><br/><span class="hl-1">    .</span><span class="hl-6">replace</span><span class="hl-1">(</span><span class="hl-3">&quot;src/common/&quot;</span><span class="hl-1">, </span><span class="hl-3">&quot;&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-10">// We have to give webpack a little bit to hook onto, so we remove</span><br/><span class="hl-1">  </span><span class="hl-10">// the module entrypoint and include that directly as a string to `require`</span><br/><span class="hl-1">  </span><span class="hl-0">if</span><span class="hl-1"> (</span><span class="hl-2">fullFilePath</span><span class="hl-1">.</span><span class="hl-6">startsWith</span><span class="hl-1">(</span><span class="hl-3">&quot;src/app&quot;</span><span class="hl-1">)) {</span><br/><span class="hl-1">    </span><span class="hl-0">return</span><span class="hl-1"> </span><span class="hl-6">require</span><span class="hl-1">(</span><span class="hl-3">&quot;app/&quot;</span><span class="hl-1"> + </span><span class="hl-2">replaced</span><span class="hl-1">);</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><span class="hl-0">if</span><span class="hl-1"> (</span><span class="hl-2">fullFilePath</span><span class="hl-1">.</span><span class="hl-6">startsWith</span><span class="hl-1">(</span><span class="hl-3">&quot;src/common&quot;</span><span class="hl-1">)) {</span><br/><span class="hl-1">    </span><span class="hl-0">return</span><span class="hl-1"> </span><span class="hl-6">require</span><span class="hl-1">(</span><span class="hl-3">&quot;common/&quot;</span><span class="hl-1"> + </span><span class="hl-2">replaced</span><span class="hl-1">);</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><span class="hl-0">return</span><span class="hl-1">;</span><br/><span class="hl-1">};</span><br/><br/><span class="hl-6">mountTest</span><span class="hl-1">(</span><br/><span class="hl-1">  [], </span><span class="hl-10">// files to skip altogether</span><br/><span class="hl-1">  </span><span class="hl-2">requireFileCallback</span><br/><span class="hl-1">);</span>
</code></pre>
<p>In orphic-cypress&#39; tests, it just looks like <a href="https://github.com/quotapath/orphic-cypress/blob/main/stories/mount.cy.ts">this</a></p>
<pre><code class="language-ts"><span class="hl-6">mountTest</span><span class="hl-1">([], (</span><span class="hl-2">fullFilePath</span><span class="hl-1">) </span><span class="hl-4">=&gt;</span><br/><span class="hl-1">  </span><span class="hl-6">require</span><span class="hl-1">(</span><span class="hl-3">&quot;stories/&quot;</span><span class="hl-1"> + </span><span class="hl-2">fullFilePath</span><span class="hl-1">.</span><span class="hl-6">replace</span><span class="hl-1">(</span><span class="hl-3">&quot;stories/&quot;</span><span class="hl-1">, </span><span class="hl-3">&quot;&quot;</span><span class="hl-1">))</span><br/><span class="hl-1">);</span>
</code></pre>

<a href="#switching-back-and-forth" id="switching-back-and-forth" style="color: inherit; text-decoration: none;">
  <h3>Switching back and forth</h3>
</a>
<p>You might run into cases with webpack cache where the stories are still instrumented with ts magic even though you wanted to run the require version, which will result in duplicating those tests. If you see that come up, run <code>rm -rf node_modules/.cache</code></p>
<br/>


<a href="#intercepting-api-requests" id="intercepting-api-requests" style="color: inherit; text-decoration: none;">
  <h1>Intercepting API Requests</h1>
</a>
<p>Mocking requests can be done in essentially the same way as any cypress test, via <code>cy.intercept</code>, but having some utils at hand is always nice.</p>
<p>We&#39;ve used <a href="https://github.com/nutboltu/storybook-addon-mock/">storybook-addon-mock</a> for our own storybook. Although tempted by mock service workers, storybook-addon-mock was dead simple to set up and worked out of the box. It also offers a nice and clean <code>mockData</code> story parameter which we can hook off of. So orphic-cypress exports <a href="https://quotapath.github.io/orphic-cypress/functions/intercept.mockToCyIntercept.html">mockToCyIntercept</a> which transforms the specified mock objects to intercepts. That&#39;s called on <code>executeCyTests</code> and so is automatically invoked on either isolated or non-isolated test runs, but must be manually called for external files.</p>
<p>See <a href="https://quotapath.github.io/orphic-cypress/storybook/?path=/docs/mockrequests-overview--page">storybook files</a> for example uses.</p>
<p><img src="https://user-images.githubusercontent.com/9889378/204159804-a2df1b09-7efe-4a93-8f57-a631f53401ac.png" alt="intercept api requests in cypress"></p>
<br/>


<a href="#literate-testing" id="literate-testing" style="color: inherit; text-decoration: none;">
  <h1>Literate Testing</h1>
</a>
<p>MDX is a phenomenal format for literate programming and once we had loading of MDX files down, it becomes a fantastic means of literate testing. Then I realized there was no reason in particular that we could only test components, why not units?</p>
<p>Already we had this at hand</p>
<pre><code class="language-mdx"><span class="hl-1">1 + 1 should equal 2, obviously</span><br/><br/><span class="hl-7">&lt;</span><span class="hl-8">Story</span><br/><span class="hl-1">  </span><span class="hl-9">name</span><span class="hl-1">=</span><span class="hl-3">&quot;SimpleMath&quot;</span><br/><span class="hl-1">  </span><span class="hl-9">parameters</span><span class="hl-1">=</span><span class="hl-4">{</span><span class="hl-11">{</span><br/><span class="hl-11">    </span><span class="hl-6">cy</span><span class="hl-2">:</span><span class="hl-11"> () </span><span class="hl-4">=&gt;</span><span class="hl-11"> </span><span class="hl-6">expect</span><span class="hl-11">(</span><span class="hl-17">1</span><span class="hl-11"> </span><span class="hl-1">+</span><span class="hl-11"> </span><span class="hl-17">1</span><span class="hl-11">).</span><span class="hl-2">to</span><span class="hl-11">.</span><span class="hl-6">equal</span><span class="hl-11">(</span><span class="hl-17">2</span><span class="hl-11">),</span><br/><span class="hl-11">  }</span><span class="hl-4">}</span><br/><span class="hl-7">&gt;</span><br/><span class="hl-1">  </span><span class="hl-7">&lt;&gt;&lt;/&gt;</span><br/><span class="hl-7">&lt;/</span><span class="hl-8">Story</span><span class="hl-7">&gt;</span>
</code></pre>
<p>Awesome, we can document our javascript logic in storybook with ample markdown and confirm accuracy in cypress. But, with above, nothing shows up in the cypress panel and the test code itself doesn&#39;t appear in storybook. So I made a quick <a href="https://quotapath.github.io/orphic-cypress/functions/storybook_UnitTest.UnitTest.html">UnitTest</a> component and <a href="https://quotapath.github.io/orphic-cypress/functions/storybook_UnitTest.unitTestDecorator.html">decorator</a>. Update to</p>
<pre><code class="language-diff"><span class="hl-3">- &lt;&gt;&lt;/&gt;</span><br/><span class="hl-17">+ &lt;UnitTest name=&quot;SimpleMath&quot; /&gt;</span>
</code></pre>
<p>and now you&#39;ll get the tests to render (with the caveat that its compiled code so you&#39;d have to opt out of minimization, see <a href="./.storybook/main.ts#L27">storybook main</a>.</p>
<p><img src="https://user-images.githubusercontent.com/9889378/206355127-ed6cfdf8-8021-4949-8769-f9f2080a3d06.png" alt="literate testing in storybook"></p>
<p>In storybook, that looks like this, where the top of the file is markdown and the first test display starts at the &#39;Arbitrary Task&#39; header. <a href="https://quotapath.github.io/orphic-cypress/storybook/?path=/docs/cypressutils-tasks-and-literate-testing--arbitrary-task">See it live here</a>.</p>
<p>And then in cypress, and in the &#39;canvas&#39; view, we get this</p>
<p><img src="https://user-images.githubusercontent.com/9889378/206355138-ef45d0db-bd92-47b4-9ed6-e2a626c5a2d6.png" alt="literate testing in cypress"></p>
<p>I&#39;m psyched. But did I stop there, nope. The fact that the code is compiled is a little lame. We have the mdx in a reasonable format, so we can do some slightly hacky things and support using code blocks! With this code (swap out <code>&quot;</code> for triple backticks)</p>
<pre><code><span class="hl-1">&lt;</span><span class="hl-2">Story</span><span class="hl-1"> </span><span class="hl-2">name</span><span class="hl-1">=</span><span class="hl-3">&quot;CyCodeBlock&quot;</span><span class="hl-1"> </span><span class="hl-2">parameters</span><span class="hl-1">={{ </span><span class="hl-2">cyCodeBlock:</span><span class="hl-1"> </span><span class="hl-4">true</span><span class="hl-1"> }}&gt;</span><br/><span class="hl-1">  &lt;&gt;&lt;/&gt;</span><br/><span class="hl-1">&lt;/</span><span class="hl-2">Story</span><span class="hl-1">&gt;</span><br/><br/><span class="hl-3">&quot;ts CyCodeBloc</span><span class="hl-18">k</span><br/><span class="hl-10">/**</span><br/><span class="hl-10">  * should work as a code block where this first comment is an optional</span><br/><span class="hl-10">  * description; it can be any kind of js comment as long as it&#39;s the first</span><br/><span class="hl-10">  * thing in the block</span><br/><span class="hl-10">  */</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-5">expected</span><span class="hl-1">: </span><span class="hl-8">number</span><span class="hl-1"> = </span><span class="hl-17">2</span><span class="hl-1">;</span><br/><br/><span class="hl-2">cy</span><span class="hl-1">.</span><span class="hl-6">arbitraryTask</span><span class="hl-1">(</span><span class="hl-17">2</span><span class="hl-1">).</span><span class="hl-6">then</span><span class="hl-1">((</span><span class="hl-2">$num</span><span class="hl-1">) </span><span class="hl-4">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-6">expect</span><span class="hl-1">(</span><span class="hl-2">$num</span><span class="hl-1">).</span><span class="hl-2">to</span><span class="hl-1">.</span><span class="hl-6">equal</span><span class="hl-1">(</span><span class="hl-2">expected</span><span class="hl-1">);</span><br/><span class="hl-1">});</span><br/><span class="hl-3">&quot;</span>
</code></pre>
<p>we get this in storybook in the first image and cypress in the second</p>
<p><img src="https://user-images.githubusercontent.com/9889378/206865846-9715783f-5e1f-4d05-aaab-053023360145.png" alt="code block in storybook">
<img src="https://user-images.githubusercontent.com/9889378/206865829-66fffb3a-25f6-439d-aafe-f79b7dc5912b.png" alt="code block in cypress"></p>
<p>Just link the block by story name and drop in an optional comment to become the <code>it</code> test description. Code blocks are great because they can be linted and formatted via prettier/eslint, maybe even type checked.</p>
<p>Note: this is not something we&#39;ve tried out yet, could be/probably is totally off the rails.</p>
<br/>


<a href="#test-coverage" id="test-coverage" style="color: inherit; text-decoration: none;">
  <h1>Test Coverage</h1>
</a>
<p>This turned out to be fairly simple. To instrument the code, I added <code>&#39;istanbul&#39;</code> to the babel plugins, and added a <a href="https://github.com/quotapath/orphic-cypress/blob/main/.nycrc.json">.nycrc.json</a> config file. Then for cypress to gather coverage, I added a fork of cypress&#39;s coverage lib <a href="https://github.com/bahmutov/cypress-code-coverage">@bahmutov/cypress-code-coverage</a>, following <a href="https://glebbahmutov.com/blog/component-code-coverage/">this well written blog post</a>, and that was that. Instead of opting for codecov or something, I wrote a <a href="https://github.com/quotapath/orphic-cypress/blob/main/.github/scripts/get_coverage_url.py">quick python script</a> which grabs the line coverage percentage and makes an svg via <a href="https://img.shields.io/badge/">img.shields.io</a>. Coverage for the isolated and required variants of the test runs are merged, though not for any particular reason besides curiousity. Finally the badge and the lcov gets thrown into the <code>docs</code> dir for github pages publishing, the whole process taking place within github actions.</p>

<a href="#contributing-to-this-orphic-cypress" id="contributing-to-this-orphic-cypress" style="color: inherit; text-decoration: none;">
  <h1>Contributing to this orphic-cypress</h1>
</a>
<p>Do it! That&#39;d be great. I could probably expand this a bit, but generally everything is available via npm scripts: <code>npm run test</code> runs mount/require version and <code>npm run test:isolated</code> runs isolated version, then <code>npm run test:headed</code> and <code>npm run test:isolated:headed</code> are the headed browser versions. All of those test the storybook stories located at <code>./stories</code>, as well as unit tests. <code>npm run storybook</code> will bring up that storybook environment.</p>

<a href="#a-general-overview-of-the-landscape" id="a-general-overview-of-the-landscape" style="color: inherit; text-decoration: none;">
  <h1>A General Overview of the Landscape</h1>
</a>

<a href="#what-are-component-tests" id="what-are-component-tests" style="color: inherit; text-decoration: none;">
  <h2>What are component tests?</h2>
</a>
<p>Component tests are near to unit tests in that they are low-level tests that cover small units of logic, but they also cover React (or other) components specifically and so have some concept of rendering that component in isolation to test against. This is highly preferable to end-to-end testing in that you can test in isolation from the rest of an application without a large amount of setup or database seeding, which means these tests will execute much faster. A lot has been said about component tests, so I won&#39;t go into too much detail on what they are or their value, but here&#39;s some further reading:</p>
<ul>
<li><a href="https://docs.cypress.io/guides/component-testing/writing-your-first-component-test">Cypress: Writing Your First Component Test</a></li>
<li><a href="https://reactjs.org/docs/testing.html">React: Testing Overview</a></li>
<li><a href="https://storybook.js.org/docs/react/writing-tests/interaction-testing">Storybook: Interaction Testing</a></li>
</ul>
<p>Lets take a simple example: we have a component that shows some copy if the user is not permissioned, but shows some copy and does a bit of logic if they do have access. Here&#39;s some pseudo-code of what you&#39;d expect to see as tests:</p>
<pre><code class="language-tsx"><span class="hl-6">it</span><span class="hl-1">(</span><span class="hl-3">&quot;should show copy for a user without permissions&quot;</span><span class="hl-1">, () </span><span class="hl-4">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-5">element</span><span class="hl-1"> = </span><span class="hl-6">render</span><span class="hl-1">(</span><span class="hl-7">&lt;</span><span class="hl-8">OurComponent</span><span class="hl-1"> </span><span class="hl-7">/&gt;</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-6">expect</span><span class="hl-1">(</span><span class="hl-2">element</span><span class="hl-1">.</span><span class="hl-2">text</span><span class="hl-1">).</span><span class="hl-2">to</span><span class="hl-1">.</span><span class="hl-6">equal</span><span class="hl-1">(</span><span class="hl-3">&quot;No soup for you!&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-6">it</span><span class="hl-1">(</span><span class="hl-3">&quot;should show details for a user &quot;</span><span class="hl-1">, () </span><span class="hl-4">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-5">element</span><span class="hl-1"> = </span><span class="hl-6">render</span><span class="hl-1">(</span><span class="hl-7">&lt;</span><span class="hl-8">OurComponent</span><span class="hl-1"> </span><span class="hl-9">isPermissioned</span><span class="hl-1">=</span><span class="hl-4">{true}</span><span class="hl-1"> </span><span class="hl-9">flagCount</span><span class="hl-1">=</span><span class="hl-4">{</span><span class="hl-17">4</span><span class="hl-4">}</span><span class="hl-1"> </span><span class="hl-7">/&gt;</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-6">expect</span><span class="hl-1">(</span><span class="hl-2">element</span><span class="hl-1">.</span><span class="hl-2">text</span><span class="hl-1">).</span><span class="hl-2">to</span><span class="hl-1">.</span><span class="hl-6">equal</span><span class="hl-1">(</span><br/><span class="hl-1">    </span><span class="hl-3">&quot;You have four flagged items you need to address&quot;</span><br/><span class="hl-1">  );</span><br/><span class="hl-1">  </span><span class="hl-6">expect</span><span class="hl-1">(</span><span class="hl-2">numToWord</span><span class="hl-1">).</span><span class="hl-2">to</span><span class="hl-1">.</span><span class="hl-2">be</span><span class="hl-1">.</span><span class="hl-2">calledOnce</span><span class="hl-1">.</span><span class="hl-6">with</span><span class="hl-1">(</span><span class="hl-17">4</span><span class="hl-1">);</span><br/><span class="hl-1">});</span>
</code></pre>
<p>Storybook stories make fantastic jumping off points for testing because they&#39;re fundamentally designed to illustrate common use cases and already perform a majority of the work that&#39;d need to be done to setup for that component in terms of component state and mocking API or function calls.</p>
<hr>

<a href="#nice-to-haves-for-component-tests" id="nice-to-haves-for-component-tests" style="color: inherit; text-decoration: none;">
  <h3>Nice-to-haves for component tests</h3>
</a>
<ul>
<li>They execute quickly</li>
<li>They&#39;re as easy as possible to set up with minimal boilerplate</li>
<li>Optional headed execution so that you can visually see whats happening and debug in a real browser</li>
<li>When executing headlessly in CI for instance, screenshots on errors make for similarly easy debugging as local headed execution</li>
</ul>
<hr>

<a href="#comparison-of-existing-solutions" id="comparison-of-existing-solutions" style="color: inherit; text-decoration: none;">
  <h3>Comparison of Existing Solutions</h3>
</a>

<a href="#storybook-interactive-tests" id="storybook-interactive-tests" style="color: inherit; text-decoration: none;">
  <h4>Storybook interactive tests</h4>
</a>
<p>This is the standard that we&#39;re working against here. They&#39;ll look like this when using the story function syntax</p>
<pre><code class="language-ts"><span class="hl-2">SomeStory</span><span class="hl-1">.</span><span class="hl-6">play</span><span class="hl-1"> = </span><span class="hl-4">async</span><span class="hl-1"> ({ </span><span class="hl-2">canvasElement</span><span class="hl-1"> }) </span><span class="hl-4">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-5">canvas</span><span class="hl-1"> = </span><span class="hl-6">within</span><span class="hl-1">(</span><span class="hl-2">canvasElement</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-6">expect</span><span class="hl-1">(</span><span class="hl-2">canvas</span><span class="hl-1">.</span><span class="hl-6">getByTestId</span><span class="hl-1">(</span><span class="hl-3">&quot;Attainment&quot;</span><span class="hl-1">)).</span><span class="hl-6">toBeVisible</span><span class="hl-1">();</span><br/><span class="hl-1">  </span><span class="hl-10">// Should not see earnings</span><br/><span class="hl-1">  </span><span class="hl-6">expect</span><span class="hl-1">(</span><span class="hl-2">canvas</span><span class="hl-1">.</span><span class="hl-6">queryByTestId</span><span class="hl-1">(</span><span class="hl-3">&quot;Earnings&quot;</span><span class="hl-1">)).</span><span class="hl-6">toEqual</span><span class="hl-1">(</span><span class="hl-4">null</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-10">// Should not see more menu</span><br/><span class="hl-1">  </span><span class="hl-6">expect</span><span class="hl-1">(</span><span class="hl-2">canvas</span><span class="hl-1">.</span><span class="hl-6">queryByTestId</span><span class="hl-1">(</span><span class="hl-3">&quot;moreMenu-team&quot;</span><span class="hl-1">)).</span><span class="hl-6">toEqual</span><span class="hl-1">(</span><span class="hl-4">null</span><span class="hl-1">);</span><br/><span class="hl-1">};</span>
</code></pre>
<ul>
<li>Pros:<ul>
<li>Theyre built into storybook so you get to show interactive stories right there</li>
<li>Weve already written some. Pretty smooth experience</li>
<li><code>actions</code> are automatically supplied and are stubs for easy testing</li>
</ul>
</li>
<li>Cons:<ul>
<li>It requires new knowledge. Jest and testing-library instead of cypress and chai, alongside some specifics to storybook execution</li>
<li>Its a true pain to set up in CI. They have their own test runner in playwrite, but I couldnt get it working with a quick pass in circleci. I built a custom cypress executor, but that broke when we moved to nginx.</li>
</ul>
</li>
</ul>
<hr>

<a href="#cypress-execution-of-builtin-interactive-tests-by-visiting-the-story39s-url-or-iframe" id="cypress-execution-of-builtin-interactive-tests-by-visiting-the-story39s-url-or-iframe" style="color: inherit; text-decoration: none;">
  <h4>Cypress execution of builtin interactive tests by visiting the story&#39;s url or iframe</h4>
</a>
<p>This was another path I&#39;d gone down. You can have hit storybook via an e2e cypress configuration and then do some combination of loading the normal page, writing an assertion against the interactive addon panel, going to the iframe and/or hooking into cypress internals all while writing some of the assertions in storybook and some in cypress. It ends up being a bizarre hybrid. Storybook themselves <a href="https://storybook.js.org/docs/react/writing-tests/importing-stories-in-tests#example-with-cypress">have an example of this sort</a>. Rarely if ever is the automatic execution of stories mentioned.</p>
<p>Which is why I kind of liked our approach. A first attempt traversed the sidebar and checked the interactions panel, but a second one got the stories.json output, went to the generic iframe page and hooked into storybook&#39;s event emitter to load stories and execute play, like so:</p>
<pre><code class="language-ts"><span class="hl-10">/**</span><br/><span class="hl-10"> * Test that there are no errors in a storybook&#39;s iframe, which will throw exceptions</span><br/><span class="hl-10"> * for expect assertion failures.</span><br/><span class="hl-10"> *</span><br/><span class="hl-10"> * Expects to already be on the styleguide page from a previous `cy.visitStyleguide`</span><br/><span class="hl-10"> * but will go to a story if needed.</span><br/><span class="hl-10"> */</span><br/><span class="hl-0">export</span><span class="hl-1"> </span><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-6">testStory</span><span class="hl-1"> = ({ </span><span class="hl-2">id</span><span class="hl-1">: </span><span class="hl-2">storyId</span><span class="hl-1"> }: { </span><span class="hl-2">id</span><span class="hl-1">: </span><span class="hl-8">string</span><span class="hl-1"> }) </span><span class="hl-4">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-10">// for some reason, error state requires a full revisit</span><br/><span class="hl-1">  </span><span class="hl-2">cy</span><span class="hl-1">.</span><span class="hl-6">window</span><span class="hl-1">().</span><span class="hl-6">then</span><span class="hl-1">((</span><span class="hl-2">win</span><span class="hl-1">) </span><span class="hl-4">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-10">// @ts-ignore</span><br/><span class="hl-1">    </span><span class="hl-0">if</span><span class="hl-1"> (</span><span class="hl-2">win</span><span class="hl-1">.</span><span class="hl-2">__test_runner_error</span><span class="hl-1">) {</span><br/><span class="hl-1">      </span><span class="hl-10">// @ts-ignore</span><br/><span class="hl-1">      </span><span class="hl-2">win</span><span class="hl-1">.</span><span class="hl-2">__test_runner_error</span><span class="hl-1"> = </span><span class="hl-4">false</span><span class="hl-1">;</span><br/><span class="hl-1">      </span><span class="hl-0">return</span><span class="hl-1"> </span><span class="hl-2">cy</span><span class="hl-1">.</span><span class="hl-6">visitStyleguide</span><span class="hl-1">(</span><span class="hl-2">storyId</span><span class="hl-1">, </span><span class="hl-4">true</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  });</span><br/><span class="hl-1">  </span><span class="hl-2">cy</span><span class="hl-1">.</span><span class="hl-6">get</span><span class="hl-1">(</span><span class="hl-3">&quot;#root&quot;</span><span class="hl-1">).</span><span class="hl-6">should</span><span class="hl-1">(</span><span class="hl-3">&quot;exist&quot;</span><span class="hl-1">);</span><br/><br/><span class="hl-1">  </span><span class="hl-10">// pure documentation pages do not register &#39;storyRendered&#39; etc events</span><br/><span class="hl-1">  </span><span class="hl-0">if</span><span class="hl-1"> (</span><span class="hl-12">/--page</span><span class="hl-16">$</span><span class="hl-12">/</span><span class="hl-1">.</span><span class="hl-6">test</span><span class="hl-1">(</span><span class="hl-2">storyId</span><span class="hl-1">)) </span><span class="hl-0">return</span><span class="hl-1">;</span><br/><br/><span class="hl-1">  </span><span class="hl-10">// adapted from storybook&#39;s playwright test runner</span><br/><span class="hl-1">  </span><span class="hl-10">// https://github.com/storybookjs/test-runner/blob/next/playwright/custom-environment.js#L110-L124</span><br/><span class="hl-1">  </span><span class="hl-2">cy</span><span class="hl-1">.</span><span class="hl-6">window</span><span class="hl-1">()</span><br/><span class="hl-1">    .</span><span class="hl-6">its</span><span class="hl-1">(</span><span class="hl-3">&quot;__STORYBOOK_ADDONS_CHANNEL__&quot;</span><span class="hl-1">)</span><br/><span class="hl-1">    .</span><span class="hl-6">then</span><span class="hl-1">((</span><span class="hl-2">channel</span><span class="hl-1">) </span><span class="hl-4">=&gt;</span><br/><span class="hl-1">      </span><span class="hl-4">new</span><span class="hl-1"> </span><span class="hl-8">Promise</span><span class="hl-1">((</span><span class="hl-2">resolve</span><span class="hl-1">, </span><span class="hl-2">reject</span><span class="hl-1">) </span><span class="hl-4">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-2">channel</span><span class="hl-1">.</span><span class="hl-6">once</span><span class="hl-1">(</span><span class="hl-3">&quot;storyRendered&quot;</span><span class="hl-1">, </span><span class="hl-2">resolve</span><span class="hl-1">);</span><br/><span class="hl-1">        </span><span class="hl-2">channel</span><span class="hl-1">.</span><span class="hl-6">once</span><span class="hl-1">(</span><span class="hl-3">&quot;storyUnchanged&quot;</span><span class="hl-1">, </span><span class="hl-2">resolve</span><span class="hl-1">);</span><br/><span class="hl-1">        </span><span class="hl-2">channel</span><span class="hl-1">.</span><span class="hl-6">once</span><span class="hl-1">(</span><span class="hl-3">&quot;storyErrored&quot;</span><span class="hl-1">, ({ </span><span class="hl-2">description</span><span class="hl-1"> }) </span><span class="hl-4">=&gt;</span><br/><span class="hl-1">          </span><span class="hl-6">reject</span><span class="hl-1">(</span><span class="hl-4">new</span><span class="hl-1"> </span><span class="hl-6">StorybookTestRunnerError</span><span class="hl-1">(</span><span class="hl-2">storyId</span><span class="hl-1">, </span><span class="hl-2">description</span><span class="hl-1">))</span><br/><span class="hl-1">        );</span><br/><span class="hl-1">        </span><span class="hl-2">channel</span><span class="hl-1">.</span><span class="hl-6">once</span><span class="hl-1">(</span><span class="hl-3">&quot;storyThrewException&quot;</span><span class="hl-1">, (</span><span class="hl-2">error</span><span class="hl-1">: </span><span class="hl-8">Error</span><span class="hl-1">) </span><span class="hl-4">=&gt;</span><br/><span class="hl-1">          </span><span class="hl-6">reject</span><span class="hl-1">(</span><span class="hl-4">new</span><span class="hl-1"> </span><span class="hl-6">StorybookTestRunnerError</span><span class="hl-1">(</span><span class="hl-2">storyId</span><span class="hl-1">, </span><span class="hl-2">error</span><span class="hl-1">.</span><span class="hl-2">message</span><span class="hl-1">))</span><br/><span class="hl-1">        );</span><br/><span class="hl-1">        </span><span class="hl-2">channel</span><span class="hl-1">.</span><span class="hl-6">once</span><span class="hl-1">(</span><br/><span class="hl-1">          </span><span class="hl-3">&quot;storyMissing&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">          (</span><span class="hl-2">id</span><span class="hl-1">: </span><span class="hl-8">string</span><span class="hl-1">) </span><span class="hl-4">=&gt;</span><br/><span class="hl-1">            </span><span class="hl-2">id</span><span class="hl-1"> === </span><span class="hl-2">storyId</span><span class="hl-1"> &amp;&amp;</span><br/><span class="hl-1">            </span><span class="hl-6">reject</span><span class="hl-1">(</span><br/><span class="hl-1">              </span><span class="hl-4">new</span><span class="hl-1"> </span><span class="hl-6">StorybookTestRunnerError</span><span class="hl-1">(</span><br/><span class="hl-1">                </span><span class="hl-2">storyId</span><span class="hl-1">,</span><br/><span class="hl-1">                </span><span class="hl-3">&quot;The story was missing when trying to access it.&quot;</span><br/><span class="hl-1">              )</span><br/><span class="hl-1">            )</span><br/><span class="hl-1">        );</span><br/><span class="hl-1">        </span><span class="hl-2">channel</span><span class="hl-1">.</span><span class="hl-6">emit</span><span class="hl-1">(</span><span class="hl-3">&quot;setCurrentStory&quot;</span><span class="hl-1">, { </span><span class="hl-2">storyId</span><span class="hl-1"> });</span><br/><span class="hl-1">      }).</span><span class="hl-6">catch</span><span class="hl-1">((</span><span class="hl-2">e</span><span class="hl-1">) </span><span class="hl-4">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-2">cy</span><span class="hl-1">.</span><span class="hl-6">window</span><span class="hl-1">().</span><span class="hl-6">then</span><span class="hl-1">((</span><span class="hl-2">win</span><span class="hl-1">) </span><span class="hl-4">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">          </span><span class="hl-10">// @ts-ignore</span><br/><span class="hl-1">          </span><span class="hl-2">win</span><span class="hl-1">.</span><span class="hl-2">__test_runner_error</span><span class="hl-1"> = </span><span class="hl-4">true</span><span class="hl-1">;</span><br/><span class="hl-1">          </span><span class="hl-0">throw</span><span class="hl-1"> </span><span class="hl-2">e</span><span class="hl-1">;</span><br/><span class="hl-1">        });</span><br/><span class="hl-1">      })</span><br/><span class="hl-1">    );</span><br/><span class="hl-1">};</span>
</code></pre>
<p>Which, as the code docs say, was inspired by the official storybook playwright runner. Again, very cool, but ulimately, in our opinion, an untenable hybrid with too much cognitive overhead.</p>
<hr>

<a href="#cypress-component-tests-directly-without-storybook" id="cypress-component-tests-directly-without-storybook" style="color: inherit; text-decoration: none;">
  <h4>Cypress component tests directly without storybook</h4>
</a>
<p>They look like this (example pulled from cypress docs):</p>
<pre><code class="language-tsx"><span class="hl-0">import</span><span class="hl-1"> { </span><span class="hl-2">Stepper</span><span class="hl-1"> } </span><span class="hl-0">from</span><span class="hl-1"> </span><span class="hl-3">&quot;./&quot;</span><span class="hl-1">;</span><br/><br/><span class="hl-6">it</span><span class="hl-1">(</span><span class="hl-3">&quot;stepper should default to 0&quot;</span><span class="hl-1">, () </span><span class="hl-4">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-2">cy</span><span class="hl-1">.</span><span class="hl-6">mount</span><span class="hl-1">(</span><span class="hl-7">&lt;</span><span class="hl-8">Stepper</span><span class="hl-1"> </span><span class="hl-7">/&gt;</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-2">cy</span><span class="hl-1">.</span><span class="hl-6">get</span><span class="hl-1">(</span><span class="hl-2">counterSelector</span><span class="hl-1">).</span><span class="hl-6">should</span><span class="hl-1">(</span><span class="hl-3">&quot;have.text&quot;</span><span class="hl-1">, </span><span class="hl-3">&quot;0&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">});</span>
</code></pre>
<ul>
<li>Pros:<ul>
<li>We already all know cypress and its tooling</li>
<li>It&#39;s slick</li>
</ul>
</li>
<li>Cons:<ul>
<li>distinct from storybook (though see below) and so we lose that interconnectedness</li>
<li>still technically in beta, though its pretty sophisticated and clear theyre following through with it</li>
</ul>
</li>
</ul>
<hr>

<a href="#cypress-component-tests-using-storybook-components-what-this-project-does" id="cypress-component-tests-using-storybook-components-what-this-project-does" style="color: inherit; text-decoration: none;">
  <h4>Cypress component tests using storybook components. <strong>What this project does</strong></h4>
</a>
<p>These could be written in the storybook file with some type updates, or alongside in a new file. See <a href="#using-this-package">Using this package</a> above for an example of what this&#39;ll look like.</p>
<ul>
<li>Pros:<ul>
<li>We already know and love cypress</li>
<li>Uses stories as test cases, which reduces duplication and increases usefulness/documentative natures of both test and story</li>
</ul>
</li>
<li>Cons:<ul>
<li>Still wont appear in storybook so youd still have to pull up a separate process to see the interactive story/test</li>
<li>currently only works with typescript or javascript story files, not mdx</li>
</ul>
</li>
</ul>
<hr>

<a href="#jest-or-other-headless-execution-of-storybook-interactive-tests" id="jest-or-other-headless-execution-of-storybook-interactive-tests" style="color: inherit; text-decoration: none;">
  <h4>Jest, or other, headless execution of storybook interactive tests:</h4>
</a>
<p>You could execute the <code>.play</code> property in jest tests directly, and could likely write out an instrumented mocha/chai or whatever framework to support the same kind of execution.</p>
<p>Here&#39;s storybook&#39;s own example from <a href="https://storybook.js.org/addons/@storybook/testing-react">testing-react docs</a></p>
<pre><code class="language-tsx"><span class="hl-4">const</span><span class="hl-1"> { </span><span class="hl-5">InputFieldFilled</span><span class="hl-1"> } = </span><span class="hl-6">composeStories</span><span class="hl-1">(</span><span class="hl-2">stories</span><span class="hl-1">);</span><br/><br/><span class="hl-6">test</span><span class="hl-1">(</span><span class="hl-3">&quot;renders with play function&quot;</span><span class="hl-1">, </span><span class="hl-4">async</span><span class="hl-1"> () </span><span class="hl-4">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">const</span><span class="hl-1"> { </span><span class="hl-5">container</span><span class="hl-1"> } = </span><span class="hl-6">render</span><span class="hl-1">(</span><span class="hl-7">&lt;</span><span class="hl-8">InputFieldFilled</span><span class="hl-1"> </span><span class="hl-7">/&gt;</span><span class="hl-1">);</span><br/><br/><span class="hl-1">  </span><span class="hl-10">// pass container as canvasElement and play an interaction that fills the input</span><br/><span class="hl-1">  </span><span class="hl-0">await</span><span class="hl-1"> </span><span class="hl-2">InputFieldFilled</span><span class="hl-1">.</span><span class="hl-6">play</span><span class="hl-1">({ </span><span class="hl-2">canvasElement:</span><span class="hl-1"> </span><span class="hl-2">container</span><span class="hl-1"> });</span><br/><br/><span class="hl-1">  </span><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-5">input</span><span class="hl-1"> = </span><span class="hl-2">screen</span><span class="hl-1">.</span><span class="hl-6">getByRole</span><span class="hl-1">(</span><span class="hl-3">&quot;textbox&quot;</span><span class="hl-1">) </span><span class="hl-0">as</span><span class="hl-1"> </span><span class="hl-8">HTMLInputElement</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-6">expect</span><span class="hl-1">(</span><span class="hl-2">input</span><span class="hl-1">.</span><span class="hl-2">value</span><span class="hl-1">).</span><span class="hl-6">toEqual</span><span class="hl-1">(</span><span class="hl-3">&quot;Hello world!&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">});</span>
</code></pre>
<ul>
<li>Pros:<ul>
<li>back to tests being visible in storybook through interaction testing addon</li>
<li>simpler headless CI execution than storybook&#39;s playwrite executor</li>
</ul>
</li>
<li>Cons:<ul>
<li>only works with .tsx, not .mdx</li>
<li>wed have to build out some infrastructure to support automatic discovery and execution</li>
<li>headless, so wont get screens of component on error, but could still interact in storybook</li>
<li>back to having to know jest + testing-library</li>
</ul>
</li>
</ul>
<br/>


<a href="#whats-in-a-name" id="whats-in-a-name" style="color: inherit; text-decoration: none;">
  <h1>Whats in a name?</h1>
</a>
<p>When it comes to javascript naming, we find ourselves in a realm of mythology and powerful symbolism.
From the Greek cannon, we have the likes of Apollo and Ajax, from more recent invented myths we have Falcor, Mithril, and Zod.
The list goes on, and well it should, myths share with programming a deep understanding of the power of language and symbols.
Even in javascript testing we have Sinon, named for the Greek warrior who lied to the Trojans to convince them that the giant wooden horse at their gates was only a gift, and was totally not filled to the brim with his comrades. What a brilliant name for a mocking library.
So you&#39;d think that Cypress would join in on this tradition, the cypress being an ancient tree known throughout human culture. There is a wealth of deep symbolism there. Van Gogh claimed they looked like Egyptian obelisks and painted them with an intense fiery energy literally leaping out of the frame.</p>
<p>But no, if we dig around a bit, we find that <a href="https://docs.cypress.io/faq/questions/company-faq#Why-the-name-Cypress">cypress was named because</a></p>
<blockquote>
<p>We believe that tests should always pass -- in other words, should always be green. A cypress is an evergreen tree. So, Cypress!</p>
</blockquote>
<p>Lame. So utterly lame. So we&#39;re naming this after the <a href="https://repository.brynmawr.edu/cgi/viewcontent.cgi?article=1095&amp;context=classics_pubs">Orphic Tablets</a> which were found in the tombs of the Greeks which contained instructions on the afterlife, wherein a white cypress stands as a guidepost in that dark underworld. Fitting for tests which execute in a different realm.</p>
<blockquote>
<p>You will find in the halls of Hades a spring on the left, and standing by it, a glowing white cypress tree</p>
</blockquote>
<p>It&#39;s a literary, <em>storybook</em>, name. Why name a repo which is mostly examples? Just for fun.</p>

<a href="#some-more-ideas" id="some-more-ideas" style="color: inherit; text-decoration: none;">
  <h1>Some more ideas</h1>
</a>
<ul>
<li>vite support. I&#39;ve never used it<ul>
<li>vitest headless execution of literate testing could bypass <code>mount</code> calls</li>
</ul>
</li>
<li>mdx2 support. tried it, was fairly close</li>
<li>storybook 7 beta support</li>
<li>more transforms:<ul>
<li>add the file name as the storyname due to a common pattern we have of <code>import { RealCompName } from &quot;./&quot;; /* ... */ export const Default = () =&gt; /* single story */; Default.storyName = &quot;RealCompName;</code> so that it rolls up</li>
<li>transforms around the docgen details so that you could dynamically change them before they hit anything in storybook, e.g. add <code>_Optional_</code> to optional props b/c the red star isn&#39;t obvous enough</li>
</ul>
</li>
<li>an addon panel? Maybe it could display the results or even snapshots of the last cypress run of that test</li>
<li>e2e tests for example purposes and to validate docs, with merged coverage. e2e works fine, getting it to properly cover the storybook code wasn&#39;t yet</li>
<li>vue support. Or angular, plain html etc. not sure how much appetite I have for that since our daily driver is react and it&#39;d probably be an undertaking, but maybe. Contributions welcome!</li>
</ul>

<a href="#prior-art" id="prior-art" style="color: inherit; text-decoration: none;">
  <h1>Prior Art</h1>
</a>
<p><a href="https://www.cypress.io/blog/2021/05/19/cypress-x-storybook-2-0/">Cypress&#39;s recommendation on component testing storybook</a> by Bart Ledoux is essentially the &#39;what you can do without this package&#39;.</p>
<p><a href="https://github.com/NicholasBoll/cypress-storybook">cypress-storybook</a> is a collection of utils for e2e testing which end up hooking into storybook&#39;s event emitter. That style of testing seems less preferrable than component tests, but it&#39;s fun and some of the ideas could still be applicable</p>
</div></div>
<div class="col-4 col-menu menu-sticky-wrap menu-highlight">
<div class="tsd-navigation settings">
<details class="tsd-index-accordion"><summary class="tsd-accordion-summary">
<h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M4.93896 8.531L12 15.591L19.061 8.531L16.939 6.409L12 11.349L7.06098 6.409L4.93896 8.531Z" fill="var(--color-text)"></path></svg> Settings</h3></summary>
<div class="tsd-accordion-details">
<div class="tsd-filter-visibility">
<h4 class="uppercase">Member Visibility</h4><form>
<ul id="tsd-filter-options">
<li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li>
<li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li></ul></form></div>
<div class="tsd-theme-toggle">
<h4 class="uppercase">Theme</h4><select id="theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div>
<nav class="tsd-navigation primary">
<details class="tsd-index-accordion" open><summary class="tsd-accordion-summary">
<h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M4.93896 8.531L12 15.591L19.061 8.531L16.939 6.409L12 11.349L7.06098 6.409L4.93896 8.531Z" fill="var(--color-text)"></path></svg> Modules</h3></summary>
<div class="tsd-accordion-details">
<ul>
<li class="current selected"><a href="modules.html">Orphic <wbr/>Cypress</a>
<ul>
<li class="tsd-kind-module"><a href="modules/actions.html">actions</a></li>
<li class="tsd-kind-module"><a href="modules/bundlers.html">bundlers</a></li>
<li class="tsd-kind-module"><a href="modules/config.html">config</a></li>
<li class="tsd-kind-module"><a href="modules/cypress.html">cypress</a></li>
<li class="tsd-kind-module"><a href="modules/execute.html">execute</a></li>
<li class="tsd-kind-module"><a href="modules/intercept.html">intercept</a></li>
<li class="tsd-kind-module"><a href="modules/mount.html">mount</a></li>
<li class="tsd-kind-module"><a href="modules/storybook.html">storybook</a></li>
<li class="tsd-kind-module"><a href="modules/storybook_UnitTest.html">storybook/<wbr/>Unit<wbr/>Test</a></li>
<li class="tsd-kind-module"><a href="modules/storybook_segment_mdx.html">storybook/segment-<wbr/>mdx</a></li>
<li class="tsd-kind-module"><a href="modules/storybook_story_code.html">storybook/story-<wbr/>code</a></li>
<li class="tsd-kind-module"><a href="modules/transformers.html">transformers</a></li>
<li class="tsd-kind-module"><a href="modules/types.html">types</a></li></ul></li></ul></div></details></nav></div></div>
<div class="overlay"></div><script src="assets/main.js"></script></body></html>